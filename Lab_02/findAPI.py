#!/usr/bin/env python
# -*- coding: utf-8 -*-

# to find the sys api in a function
from idaapi import *
from idautils import *
import idc 

callList = []
apiDic = {}
reg = ['eax', 'ebx', 'ecx', 'edx', 'edi', 'esi', 'esp', ]
def getAllApi():
    def imp_cb(i, name, offset):
        if name:
            apiDic[i] = name
        # True -> Continue enumeration
        # False -> Stop enumeration
        return True
    WinDll = ['']
    nimps = get_import_module_qty()
    for i in xrange(0, nimps):
        name = get_import_module_name(i)
        enum_import_names(i, imp_cb)
    return

def findAPI(entry):
    '''
    FuncItems(addr)                    addr所在函数所有指令地址
    GetMnem(addr)                      addr地址指令的操作
    GetOpnd(addr, 0)                   addr地址指令的第0个操作数(直接显示ida反编译结果)
    GetOperandValue(addr, 0)           addr地址指令的操作数的值(去掉ida识别信息，反馈原值)
    GetDisasm(addr) 打印addr地址的ida反编译结果，包括ida识别注释
    '''
    for addr in FuncItems(entry):
        op = GetMnem(addr)
        if op == 'call':
            target = GetOperandValue(addr, 0)
            if target in apiDic.keys():
                # 直接地址
                callList.append(apiDic[target])
            elif GetOpnd(addr, 0) in reg:
                # 寄存器
                # .text:004010D5 FF D3  call    ebx ; InternetWriteFile
                ins = GetDisasm(addr)
                targetFunc = ins.split('; ')[1]
                if targetFunc in apiDic.values():
                    callList.append(targetFunc)
            elif GetMnem(GetOperandValue(addr,0)) == 'jmp':
                # call    _AllocConsole@0 ; AllocConsole()
                # jmp ds:_imp_allocConsole@0 
                mid = GetOperandValue(addr, 0)
                target = GetOperandValue(mid, 0)
                if target in apiDic.keys():
                    callList.append(apiDic[target])

    return 


if __name__ == '__main__':
    # func_addr = eval(raw_input('addr of target func:'))
    print '\n-------------------------------------------------------------------------------'
    func_addr = 0x401290
    print 'sys API in func:' + hex(func_addr)
    getAllApi()

    findAPI(func_addr)
    print list(set(callList))

