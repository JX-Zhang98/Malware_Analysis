# Lab 01 - Basic Analysis

**Prework**

先使用file命令查看三个任务文件的文件类型，得到三个文件均为32位的PE文件，即win下.exe文件

![](http://ww1.sinaimg.cn/large/006z37hrly1g0nl6b68qej30k203adg0.jpg)

## Lab_01-1.malware

1. **When was this file compiled?**

   使用Visual Studio的工具‘dumpbin’可以直接查看PE程序的编译时间

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0nl28ngp3j30t40e675k.jpg)

   根据返回结果，可以确定此文件是2009年5月15日，01:12:41完成编译

   也可以根据PE的文件结构，使用010 editor查看对应位置的数据，转化成编译时间。

   当然也可以直接使用ida打开文件，在文件头处可以看到编译时间等文件信息。

   ![](img/time.png)

   但是二者的时间相差了八个小时，经过查询，是Windows和Linux之间存在八小时的时差。

2. **List a few imports or sets of imports and describe how the malware might use them.**

   使用ida打开文件，选择Imports标签，可以得到程序所引用的所有依赖库

   - KERNEL32.dll

     ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g10zia0x74j30ue0hh403.jpg)

     ​	此依赖库与内核的功能有关，用来实现系统调用功能，如线程的管理和文件读写等

   - MSVCRT.dll

     ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g0nluf8jedj30fn0b474w.jpg)

     ​	程序从此依赖库中调用多种库函数，如malloc 、free  、sprintf等

   - SHELL32.dll 、 USER32.dll

     ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g0nly8hqcjj30gr01uwed.jpg)

     ​	程序通过调用这两个依赖库实现用户层字符串加载和执行cmd命令

   - WS2_32.dll

     ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g0nm0rdkgmj30fp046jrg.jpg)

     ​	明显程序通过调用此依赖库实现网络通信

3. **What are a few strings that stick out to you and why?**

   在ida中shift+F12调出字符串窗口，可以得到程序中的字符串常量

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0nm5s4hgmj30o90bh0td.jpg)

   其中比较特殊的有：

   ​	a. http://www.ueopen.com/test.html ， 说明程序再运行过程中访问了此网页进行网络通信，但是此网站已不能访问。

   ​	b. *(SY) # cmd 与命令终端的格式类似，可能作为某种标志。

   ​	c. cmd.exe 很明显用来启动cmd程序以执行命令

   ​	d. send = %d 应该是发送一个整数，可能是通信后执行命令的参数

4. **What happens when you run this malware? Is it what you expected and why?**

   运行程序后，程序将其自身删除，并且没有任何输出。

   根据之前的分析，程序再运行时会进行网络通信，可以使用wireshark对网络流量进行监听，由于程序内嵌的网址已经不可访问，无法确定程序进行通信的目标ip，所以先以源ip进行过滤。由于是在虚拟机中进行操作，网络活动并不多，应该比较容易捕获该程序的通信流量。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0nnh20uzfj30mt0h8mxv.jpg)

   更改程序后缀为.exe后并运行后，不出预料的监测到了异常流量，目标ip是60.248.52.95，目标端口443，使用tcp协议，随后删除了自身文件，符合之前的预料。

5. **Name a procmon filter and why you used it**

   使用系统监视软件Process Monitor监控所有进程的行为，点击菜单栏的filter设置过滤规则

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0no7xkm7tj30e50fmdgk.jpg)

   在本实验中，我们只需要检测Lab_01-1.exe程序的活动，所以以进程名为过滤变量，选择process name 是 Lab_01-1.exe的活动，能够只显示属于该程序进程的活动，使得观察和分析更加容易。下图中设置了过滤规则之后，再次运行01-1程序，在版面中直接显示了该进程的全部操作，并且没有其他进程的干扰。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0nobb30brj312p0ne0w4.jpg)

6. **Are there any host­based signatures? (Files, registry keys, processes or services, etc).
   If so, what are they?**

   此程序在运行结束后会进行自我删除。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0of23kxqvj30j40e0jsp.jpg)

   在sub_401b50函数中，先通过字符串拼接，得到del *filename* > nul，然后将此字符串传入PExecInfo中作为命令的参数，再调用执行shell命令实现在程序活动结束后删除自身文件的功能。

7. **Are there any network based signatures? (URLs, packet contents. etc) If so, what are
   they?**

   程序在运行过程中访问ip为*60.248.52.95*的主机，访问的端口号为443

   之前发现发往该ip的流量时，就有的一个疑问是，该网页无法访问，而且通过ip查询工具查到该域名对应的ip为217.160.223.172，并不是发现的异常流量的目标地址。所以ip地址不是通过dns解析获得，而是存储在程序本身中。

   虽然直接查看字符串并没有发现ip:port的结构，但是在函数sub_401320内，进行建立socket通信之前，其中一句为

   > result = strchr(&::Str, ':');，

   有可能是对ip:port结构进行切割，使用ollydbg进行调试，断点在0x40132A

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0oga0b1o3j30l0047zk6.jpg)

   可以在进程中发现目标ip和端口号。

8. **Is there anything that impeded your analysis? How so? How might you overcome this?**

   程序中存储的域名已经失效，无法通过域名直接判断访问的ip地址，不能设置最严格的包过滤条件，有效过滤攻击流量

   overcome： 利用虚拟机中网络通信较为简单的特性，在以本机ip为源ip的所有流量包中寻找“异常”流量，并通过多次重复试验确定该异常流量属于恶意程序的通信。

9. **What do you think is the purpose of this malware?**

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ogvmd2wcj30j70hqgmp.jpg)

   在函数中建立socket通信之后，首先将本机的主机名发送往目标，然后接受目标的返回，根据比对的字符串可以初步判断该程序具有远程连接和远程执行命令的功能。

## Lab_01-2.malware

1. **What is the md5sum? What of interest does VirusTotal Report?**

   使用md5sum程序产生2文件的md5摘要

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ohoeo7luj30k102j3yi.jpg)

   将文件上传到Virus Total进行检测，得到结果如下：

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ohr2jyxfj312c0lpwic.jpg)

   网站将文件提供给多方病毒检测机构进行检测，结果不同的公司给出了不同的病毒类型判断，甚至alibaba等公司认为软件是安全的。说明不同公司的检测方式和匹配库都是独立的，我们进行病毒检测的时候应该进行多方验证。

2. **List a few imports or sets of imports and describe how the malware might use them.**

   ​	a. KERNEL32.dll

   ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g0oi6cjnugj30h3052dfz.jpg)

   ​	程序通过此依赖库进行系统调用使用内核的功能，如文件读写、线程管理等

   ​	b. MSVCRT.dll

   ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g0oi9iqblsj30gl0fugmm.jpg)

   ​	提供C语言库函数支持

   ​	c. WININET.dll

   ​	![](http://ww1.sinaimg.cn/large/006z37hrly1g0oiabtdkpj30fo05sglu.jpg)

   ​	明显通过此依赖库实现网络通信功能。

3. **What are a few strings that stick out to you and why?**

   在ida中通过strings窗口查看程序中的字符串常量

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0oifzi0i5j30ip0foq3u.jpg)

   其中比较特殊的有：

   ​	a. 69.25.50.10 应该是一个ip，与程序的网络通信有关

   ​	b. download file %s****%d 和 uploadfile%s****%d, 与文件的上传和下载有关的格式化字符串

   ​	c. wuauclt.exe 经过查询是Windows自动升级管理程序，可能与windows更新有关

4. **What happens when you run this malware? Is it what you expected and why?**

   在虚拟机中开始使用wireshark抓包并设置目标ip过滤条件，然后开始运行程序后，不出预料的，会与69.25.50.10进行网络通信，开始不断地向该ip发送TCP连接请求，并且会不断的使用不同端口进行尝试，且不会自动停止。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0oirike7zj30vy0f5dgm.jpg)

   

5. **Name a procmon filter and why you used it.**

   与程序1相同，为了更好的观察效果，使用进程名作为过滤条件，仅观察该进程的活动。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0oix9cc25j30e40foaar.jpg)

6. **Are there any host­based signatures? (Files, registry keys, processes or services, etc).
   If so, what are they?**

   该程序在宿主主机上运行了wuauclt.exe程序

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0oj0n9peyj30ox02oaa3.jpg)

7. **Are there any network based signatures? (URLs, packet contents. etc) If so, what are
   they?**

   该程序与69.25.50.10通信后，根据接收到的字符串执行不同的操作。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ojpmx2nej30op091mxo.jpg)

8. **Is there anything that impeded your analysis? How so? How might you overcome this?**

   该ip已经废弃，无法在运行中观察程序接收到不同的信息后的具体操作。

9. **What do you think is the purpose of this malware?**

   该程序具有远程文件上传和下载的功能和根据网络通信执行操作的功能，可能是利用了系统更新的的漏洞实现远程控制的后门程序。

## Lab_01-3.malware

1. **Are there any indications that this malware is packed? What are they? What is it
   packed with?**

   直接使用Detect it Easy进行查壳

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ok0wor3uj30g609t74x.jpg)

   发现该程序使用了UPX壳。

2. **Are you able to unpack it? Why or why not?**

   常规的upx脱壳命令没能成功脱壳，经过使用不同工具尝试后，吾爱破解UPX静态脱壳机能够成功脱壳

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ok8j8y86j308l0bjwf7.jpg)

3. **What are a few strings that stick out to you and why?**

   脱壳后的程序可以直接在ida中查看字符串

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0oke2crcoj30lk0ht0u6.jpg)

   其中大多时一些报错提示语句，一些比较有指向性的字符串有：

   ​	a. GetLastActivePopup、GetActiveWindow，应该是函数名，似乎是用来监视用户活动

   ​	b. MessageBox，弹出窗口

   ​	c. http://%s/%s/， 网站的格式化串，可能用来组成网址进行访问

4. **What happens when you run this malware? Is it what you expected and why?**

   打开wireshark进行监视后运行病毒，发现病毒与ip为192.2.78.24的主机进行了大量通信，并且该ip可用，进行了大量通信交互。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0okxpgpwkj30sp0evaav.jpg)

   update:

   经过课上老师提醒，使用regshot对比病毒运行前后差别，发现该病毒将自身加入了系统信任证书中,可能能够通过系统信任实现开机自动启动。

   ![](img/auto.png)

5. **Are there any host­based signatures? (Files, registry keys, processes or services, etc).
   If so, what are they?**

   此病毒在本地使用了浏览器作为网络代理

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ol0wwej7j30i605gq3a.jpg)

6. **Are there any network based signatures? (URLs, packet contents. etc) If so, what are
   they?**

   在程序中，通过网址的格式化字符串生成了网址，然后使用浏览器代理进行访问。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ol9qxsfsj30gd02kdfu.jpg)

   通过wireshark捕获到的流量包进行分析，可得程序对www.practicalmalwareanalysis.com进行连续访问。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0ol536tq3j30rq0f30t6.jpg)

7. **Is there anything that impeded your analysis? How so? How might you overcome this?**

   最初程序加壳没能轻易脱掉，尝试了多种工具才成功去壳，得以实现对代码的静态分析。

8. **What do you think is the purpose of this malware?**

   程序中对目标网址进行无限循环访问，并且设置开机自动自动启动，推测应该是用来为网站刷访问量或对某一网站进行Dos攻击的程序。

   ![](http://ww1.sinaimg.cn/large/006z37hrly1g0olhobetij30hc05jjrd.jpg)

